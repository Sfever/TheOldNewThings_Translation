# 开发者是怎样为Windows NT添加多架构支持的？

Windows NT从她诞生那一刻起就拥有对多种处理器架构的支持。唯一的例外是Alpha AXP停产到安腾诞生的这一段时间，但即使在这一段时间里，Windows依旧支持基于Alpha AXP的系统：她们被用于开发64位Windows。所以说Windows NT的开发永远都需要适配多种架构。这些开发是如何进行的呢？

首先可以肯定的是，每一位开发者并非拥有着所有对应架构的测试机。实际上，大部分人都在一台英特尔架构（译注：即x86）的主力机上进行开发，然后在另一台相似的机子上进行测试。有些人可能有另一台不同架构的测试机，还有些人直接在非x86上进行开发。

我确信Windows蓝屏的最初提出者Jon Vert是在一台MIPS工作站上进行开发。当Windows的MIPS支持被放弃时，他转用了一台Alpha AXP开发机。这就是对x86的“深恶痛绝”。

在很长一段时间里，Windows NT没有交叉编译器，这就意味着你需要在对应平台上编译对应平台的代码。每个团队都知道谁在负责非x86架构，当你需要在某个架构上进行测试时，他们会帮你编译好对应的二进制，然后你到他们的办公室去进行测试。

大部分时候这种测试是不必要的。Windows NT被设计成一种可移植到各种架构上的操作系统，所有在大部分时间，架构上的差别并不明显。在一种32位架构上运行良好的代码在另一种32位架构上大概也能用，并且还不错。在向64位迁移时也是类似的情况：绝大部分工作在移植到64位Alpha AXP时就已完成，而在不同64位架构之间的移植基本上只会涉及到内核部分的代码，因为只有在那里架构上的差别才变得显著起来。

但是在上层代码中还是会有可查觉到的变化，尤其是涉及到多线程和数据对齐的部分。由于英特尔处理器拥有更严格的内存模型，一些会在其他处理器上导致问题的多线程内存问题在这些处理器上不会表现出来。同时英特尔处理器对没有对齐的数据相对宽容，使用没有对齐的指针很可能在这里运行良好，但在别的地方崩的妈都不认识。我们通过严格的代码审查与大量的测试来尽量避免这些问题。

Windows部门直到现在仍然使用类似的方法。现代Windows支持32与64位x86和ARM，大部分开发者在x86-64机器上编写代码，然后在32与64位x86虚拟机中测试。开发ARM专属功能的人通常还有一台ARM测试机。介于现在已经有了交叉编译，你可以在x86开发机上直接编译ARM二进制，不需要再去配置一套ARM上的环境